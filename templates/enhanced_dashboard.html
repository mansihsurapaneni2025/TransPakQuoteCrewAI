{% extends "base.html" %}

{% block title %}Enhanced Analytics Dashboard - TransPak AI Quoter{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary-color: #A41E21;
            --secondary-color: #667eea;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --dark-bg: #1a1a1a;
            --card-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        

        
        .dashboard-container {
            padding: 2rem 0;
        }
        
        .dashboard-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.12);
        }
        
        .card-header-custom {
            background: linear-gradient(135deg, var(--primary-color) 0%, #c41e3a 100%);
            color: white;
            padding: 1.5rem;
            border: none;
        }
        
        .card-header-secondary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border: none;
        }
        
        .card-header-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
            color: white;
            padding: 1.5rem;
            border: none;
        }
        
        .card-header-info {
            background: linear-gradient(135deg, var(--info-color) 0%, #6f42c1 100%);
            color: white;
            padding: 1.5rem;
            border: none;
        }
        
        .card-header-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #fd7e14 100%);
            color: white;
            padding: 1.5rem;
            border: none;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            height: 100%;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .metric-change {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            font-weight: 500;
        }
        
        .metric-change.positive {
            color: var(--success-color);
        }
        
        .metric-change.negative {
            color: var(--danger-color);
        }
        
        .agent-status {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: white;
            transition: all 0.3s ease;
        }
        
        .agent-status:hover {
            background: #f8f9fa;
            border-color: var(--primary-color);
        }
        
        .agent-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 1rem;
            animation: pulse 2s infinite;
        }
        
        .agent-indicator.active {
            background: var(--success-color);
        }
        
        .agent-indicator.busy {
            background: var(--warning-color);
        }
        
        .agent-indicator.error {
            background: var(--danger-color);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .map-container {
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            padding: 1rem;
        }
        
        .ai-decision-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .confidence-meter {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .real-time-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            animation: blink 1s infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .prediction-card {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .trend-arrow {
            font-size: 1.2rem;
            margin-left: 0.5rem;
        }
        
        .trend-up {
            color: var(--success-color);
        }
        
        .trend-down {
            color: var(--danger-color);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .filter-controls {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .btn-filter {
            margin: 0.25rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 2px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            transition: all 0.3s ease;
        }
        
        .btn-filter:hover, .btn-filter.active {
            background: var(--primary-color);
            color: white;
        }
    </style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
        <div class="container-fluid">
            <!-- Header with Real-Time Indicator -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="h2 mb-0">
                        <span class="real-time-indicator"></span>
                        Enhanced Analytics Dashboard
                    </h1>
                    <p class="text-muted">Real-time insights into AI agent performance and business metrics</p>
                </div>
            </div>

            <!-- 1. Real-Time Agent Performance Monitor -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="dashboard-card">
                        <div class="card-header-custom">
                            <h4 class="mb-0">
                                <i class="fas fa-robot me-2"></i>
                                Real-Time Agent Performance Monitor
                            </h4>
                        </div>
                        <div class="card-body p-0">
                            <div class="row g-0">
                                <div class="col-md-3">
                                    <div class="agent-status" id="sales-agent">
                                        <div class="agent-indicator active"></div>
                                        <div>
                                            <div class="fw-bold">Sales Briefing Agent</div>
                                            <small class="text-muted">Response Time: <span id="sales-time">0.8s</span></small>
                                            <div class="small">Success Rate: <span id="sales-success">98.5%</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="agent-status" id="crating-agent">
                                        <div class="agent-indicator busy"></div>
                                        <div>
                                            <div class="fw-bold">Crating Design Agent</div>
                                            <small class="text-muted">Response Time: <span id="crating-time">1.2s</span></small>
                                            <div class="small">Success Rate: <span id="crating-success">96.8%</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="agent-status" id="logistics-agent">
                                        <div class="agent-indicator active"></div>
                                        <div>
                                            <div class="fw-bold">Logistics Planner Agent</div>
                                            <small class="text-muted">Response Time: <span id="logistics-time">0.9s</span></small>
                                            <div class="small">Success Rate: <span id="logistics-success">97.2%</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="agent-status" id="consolidator-agent">
                                        <div class="agent-indicator active"></div>
                                        <div>
                                            <div class="fw-bold">Quote Consolidator Agent</div>
                                            <small class="text-muted">Response Time: <span id="consolidator-time">1.1s</span></small>
                                            <div class="small">Success Rate: <span id="consolidator-success">99.1%</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="p-3">
                                <div class="chart-container">
                                    <canvas id="agentPerformanceChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Interactive Quote Analytics -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="dashboard-card">
                        <div class="card-header-secondary">
                            <h4 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>
                                Interactive Quote Analytics
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="filter-controls">
                                <button class="btn btn-filter active" data-period="7d">7 Days</button>
                                <button class="btn btn-filter" data-period="30d">30 Days</button>
                                <button class="btn btn-filter" data-period="90d">90 Days</button>
                                <button class="btn btn-filter" data-period="1y">1 Year</button>
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="chart-container">
                                        <canvas id="quoteAnalyticsChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="row">
                                        <div class="col-12 mb-3">
                                            <div class="metric-card">
                                                <div class="metric-value text-primary" id="total-quotes">0</div>
                                                <div class="metric-label">Total Quotes</div>
                                                <div class="metric-change positive" id="quotes-change">+12.5% vs last period</div>
                                            </div>
                                        </div>
                                        <div class="col-12 mb-3">
                                            <div class="metric-card">
                                                <div class="metric-value text-success" id="conversion-rate">0%</div>
                                                <div class="metric-label">Conversion Rate</div>
                                                <div class="metric-change positive" id="conversion-change">+3.2% vs last period</div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="metric-card">
                                                <div class="metric-value text-info" id="avg-value">$0</div>
                                                <div class="metric-label">Average Quote Value</div>
                                                <div class="metric-change negative" id="value-change">-2.1% vs last period</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Geographic Route Visualization -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="dashboard-card">
                        <div class="card-header-success">
                            <h4 class="mb-0">
                                <i class="fas fa-globe-americas me-2"></i>
                                Global Shipping Routes & Activity
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div id="shipping-map" class="map-container"></div>
                                </div>
                                <div class="col-md-4">
                                    <h6>Top Routes This Week</h6>
                                    <div id="top-routes">
                                        <!-- Dynamic content will be inserted here -->
                                    </div>
                                    <h6 class="mt-3">Regional Activity</h6>
                                    <div class="chart-container" style="height: 200px;">
                                        <canvas id="regionalChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. AI Decision Transparency Panel -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="dashboard-card">
                        <div class="card-header-info">
                            <h4 class="mb-0">
                                <i class="fas fa-brain me-2"></i>
                                AI Decision Transparency
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="ai-decision-panel">
                                        <h6>Latest Quote Analysis</h6>
                                        <div id="latest-decision">
                                            <div class="mb-2">
                                                <strong>Decision:</strong> <span id="decision-text">Recommended premium packaging for fragile electronics</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Confidence:</strong>
                                                <div class="confidence-meter">
                                                    <div class="confidence-fill" id="confidence-bar" style="width: 95%"></div>
                                                </div>
                                                <span id="confidence-value">95%</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Reasoning:</strong> <span id="reasoning-text">High fragility rating + electronics classification triggered enhanced protection protocols</span>
                                            </div>
                                            <div class="small">
                                                <strong>Data Sources:</strong> <span id="data-sources">Item classification (98% confidence), fragility assessment, carrier performance data</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>AI vs Traditional Comparison</h6>
                                    <div class="chart-container" style="height: 250px;">
                                        <canvas id="comparisonChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. Predictive Business Intelligence -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="dashboard-card">
                        <div class="card-header-warning">
                            <h4 class="mb-0">
                                <i class="fas fa-crystal-ball me-2"></i>
                                Predictive Business Intelligence
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="chart-container">
                                        <canvas id="forecastChart"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="prediction-card">
                                        <h6>7-Day Forecast</h6>
                                        <div class="mb-2">
                                            <strong>Expected Quotes:</strong> 
                                            <span id="forecast-quotes">145</span>
                                            <i class="fas fa-arrow-up trend-arrow trend-up"></i>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Revenue Projection:</strong> 
                                            <span id="forecast-revenue">$89,500</span>
                                            <i class="fas fa-arrow-up trend-arrow trend-up"></i>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Market Confidence:</strong> 
                                            <span id="market-confidence">High</span>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <h6>Market Alerts</h6>
                                        <div id="market-alerts">
                                            <!-- Dynamic alerts will be inserted here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Dashboard JavaScript -->
    <script>
        // Global variables for charts and data
        let agentChart, analyticsChart, regionalChart, comparisonChart, forecastChart;
        let map;
        let updateInterval;
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            startRealTimeUpdates();
        });
        
        function initializeDashboard() {
            initializeAgentMonitor();
            initializeQuoteAnalytics();
            initializeMap();
            initializeAITransparency();
            initializePredictiveAnalytics();
        }
        
        function initializeAgentMonitor() {
            const ctx = document.getElementById('agentPerformanceChart').getContext('2d');
            agentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sales Agent',
                        data: [],
                        borderColor: '#A41E21',
                        backgroundColor: 'rgba(164, 30, 33, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Crating Agent',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Logistics Agent',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Consolidator Agent',
                        data: [],
                        borderColor: '#17a2b8',
                        backgroundColor: 'rgba(23, 162, 184, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Success Rate (%)'
                            }
                        }
                    }
                }
            });
        }
        
        function initializeQuoteAnalytics() {
            const ctx = document.getElementById('quoteAnalyticsChart').getContext('2d');
            analyticsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Quote Volume',
                        data: [],
                        borderColor: '#A41E21',
                        backgroundColor: 'rgba(164, 30, 33, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Conversion Rate',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Quote Volume'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Conversion Rate (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
            
            // Initialize regional chart
            const regionalCtx = document.getElementById('regionalChart').getContext('2d');
            regionalChart = new Chart(regionalCtx, {
                type: 'doughnut',
                data: {
                    labels: ['North America', 'Europe', 'Asia Pacific', 'Other'],
                    datasets: [{
                        data: [45, 25, 20, 10],
                        backgroundColor: ['#A41E21', '#667eea', '#28a745', '#ffc107']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function initializeMap() {
            // Initialize Leaflet map
            map = L.map('shipping-map').setView([40.7128, -74.0060], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add sample shipping routes
            const routes = [
                {from: [40.7128, -74.0060], to: [51.5074, -0.1278], color: '#A41E21', quotes: 25},
                {from: [37.7749, -122.4194], to: [35.6762, 139.6503], color: '#667eea', quotes: 18},
                {from: [41.8781, -87.6298], to: [52.5200, 13.4050], color: '#28a745', quotes: 22},
                {from: [29.7604, -95.3698], to: [-33.8688, 151.2093], color: '#ffc107', quotes: 15}
            ];
            
            routes.forEach(route => {
                const polyline = L.polyline([route.from, route.to], {
                    color: route.color,
                    weight: 3,
                    opacity: 0.7
                }).addTo(map);
                
                // Add markers for cities
                L.circleMarker(route.from, {
                    radius: 6,
                    fillColor: route.color,
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup(`Active quotes: ${route.quotes}`);
                
                L.circleMarker(route.to, {
                    radius: 6,
                    fillColor: route.color,
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup(`Active quotes: ${route.quotes}`);
            });
            
            // Update top routes
            updateTopRoutes();
        }
        
        function initializeAITransparency() {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Accuracy', 'Speed', 'Cost Savings', 'Customer Satisfaction'],
                    datasets: [{
                        label: 'AI-Generated',
                        data: [95, 88, 92, 89],
                        backgroundColor: '#A41E21'
                    }, {
                        label: 'Traditional',
                        data: [78, 45, 65, 72],
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Performance Score'
                            }
                        }
                    }
                }
            });
        }
        
        function initializePredictiveAnalytics() {
            const ctx = document.getElementById('forecastChart').getContext('2d');
            
            // Generate forecast data
            const historicalData = generateHistoricalData();
            const forecastData = generateForecastData();
            
            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [...historicalData.labels, ...forecastData.labels],
                    datasets: [{
                        label: 'Historical',
                        data: [...historicalData.data, ...Array(forecastData.labels.length).fill(null)],
                        borderColor: '#A41E21',
                        backgroundColor: 'rgba(164, 30, 33, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Forecast',
                        data: [...Array(historicalData.labels.length).fill(null), ...forecastData.data],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderDash: [5, 5],
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quote Volume'
                            }
                        }
                    }
                }
            });
            
            // Update market alerts
            updateMarketAlerts();
        }
        
        function startRealTimeUpdates() {
            // Initial data load
            loadAgentPerformance();
            loadQuoteAnalytics();
            loadGeographicData();
            loadAIDecisions();
            loadPredictiveAnalytics();
            
            // Set up real-time updates
            updateInterval = setInterval(() => {
                loadAgentPerformance();
                loadRealTimeMetrics();
                loadAIDecisions();
            }, 10000); // Update every 10 seconds
        }
        
        async function loadAgentPerformance() {
            try {
                const response = await fetch('/api/dashboard/agent-performance');
                const data = await response.json();
                
                if (data.success) {
                    // Update agent metrics display
                    data.agents.forEach(agent => {
                        const agentKey = agent.id.split('_')[1]; // Extract agent type from ID
                        const timeElement = document.getElementById(`${agentKey}-time`);
                        const successElement = document.getElementById(`${agentKey}-success`);
                        const statusElement = document.querySelector(`#${agentKey}-agent .agent-indicator`);
                        
                        if (timeElement) timeElement.textContent = `${agent.response_time}s`;
                        if (successElement) successElement.textContent = `${agent.success_rate}%`;
                        if (statusElement) {
                            statusElement.className = `agent-indicator ${agent.status}`;
                        }
                    });
                    
                    // Update agent performance chart with real data
                    if (agentChart) {
                        const now = new Date().toLocaleTimeString();
                        agentChart.data.labels.push(now);
                        
                        // Keep only last 10 data points
                        if (agentChart.data.labels.length > 10) {
                            agentChart.data.labels.shift();
                            agentChart.data.datasets.forEach(dataset => {
                                dataset.data.shift();
                            });
                        }
                        
                        // Add real performance data
                        data.agents.forEach((agent, index) => {
                            if (agentChart.data.datasets[index]) {
                                agentChart.data.datasets[index].data.push(agent.success_rate);
                            }
                        });
                        
                        agentChart.update('none');
                    }
                }
            } catch (error) {
                console.error('Error loading agent performance:', error);
            }
        }
        
        async function loadQuoteAnalytics() {
            try {
                const activeFilter = document.querySelector('.btn-filter.active');
                const period = activeFilter ? activeFilter.getAttribute('data-period') : '7d';
                
                const response = await fetch(`/api/dashboard/quote-analytics?period=${period}`);
                const data = await response.json();
                
                if (data.success) {
                    // Update summary metrics
                    document.getElementById('total-quotes').textContent = data.summary.total_quotes;
                    document.getElementById('conversion-rate').textContent = `${data.summary.conversion_rate}%`;
                    document.getElementById('avg-value').textContent = `$${Math.round(data.summary.avg_quote_value).toLocaleString()}`;
                    
                    // Update analytics chart with real data
                    if (analyticsChart) {
                        analyticsChart.data.labels = data.chart_data.labels;
                        analyticsChart.data.datasets[0].data = data.chart_data.quote_volumes;
                        analyticsChart.data.datasets[1].data = data.chart_data.quote_volumes.map(vol => 
                            vol > 0 ? (data.summary.conversion_rate + Math.random() * 10 - 5) : 0
                        );
                        analyticsChart.update();
                    }
                    
                    // Update change indicators based on trends
                    updateChangeIndicators(data.chart_data);
                }
            } catch (error) {
                console.error('Error loading quote analytics:', error);
            }
        }
        
        async function loadGeographicData() {
            try {
                const response = await fetch('/api/dashboard/geographic-data');
                const data = await response.json();
                
                if (data.success) {
                    // Update top routes display
                    updateTopRoutes(data.top_routes);
                    
                    // Update regional chart
                    if (regionalChart) {
                        const regions = Object.keys(data.regional_distribution);
                        const counts = Object.values(data.regional_distribution);
                        
                        regionalChart.data.labels = regions;
                        regionalChart.data.datasets[0].data = counts;
                        regionalChart.update();
                    }
                    
                    // Update map with real route data
                    updateMapWithRealData(data.top_routes);
                }
            } catch (error) {
                console.error('Error loading geographic data:', error);
            }
        }
        
        async function loadAIDecisions() {
            try {
                const response = await fetch('/api/dashboard/ai-decisions');
                const data = await response.json();
                
                if (data.success) {
                    // Update AI decision display
                    const decision = data.latest_decision;
                    document.getElementById('decision-text').textContent = decision.decision_text;
                    document.getElementById('confidence-value').textContent = `${decision.confidence}%`;
                    document.getElementById('confidence-bar').style.width = `${decision.confidence}%`;
                    document.getElementById('reasoning-text').textContent = decision.reasoning;
                    document.getElementById('data-sources').textContent = decision.data_sources;
                    
                    // Update comparison chart
                    if (comparisonChart) {
                        const metrics = data.comparison_metrics;
                        comparisonChart.data.datasets[0].data = [
                            metrics.ai_accuracy,
                            metrics.ai_speed,
                            metrics.ai_cost_savings,
                            metrics.ai_satisfaction
                        ];
                        comparisonChart.data.datasets[1].data = [
                            metrics.traditional_accuracy,
                            metrics.traditional_speed,
                            metrics.traditional_cost_savings,
                            metrics.traditional_satisfaction
                        ];
                        comparisonChart.update();
                    }
                }
            } catch (error) {
                console.error('Error loading AI decisions:', error);
            }
        }
        
        async function loadPredictiveAnalytics() {
            try {
                const response = await fetch('/api/dashboard/predictive-analytics');
                const data = await response.json();
                
                if (data.success) {
                    // Update forecast display
                    const forecast = data.forecast.next_7_days;
                    document.getElementById('forecast-quotes').textContent = forecast.expected_quotes;
                    document.getElementById('forecast-revenue').textContent = `$${forecast.expected_revenue.toLocaleString()}`;
                    document.getElementById('market-confidence').textContent = data.market_confidence.level;
                    
                    // Update market alerts
                    updateMarketAlertsFromAPI(data.market_alerts);
                    
                    // Update forecast chart with real historical and predicted data
                    updateForecastChart(data);
                }
            } catch (error) {
                console.error('Error loading predictive analytics:', error);
            }
        }
        
        async function loadRealTimeMetrics() {
            try {
                const response = await fetch('/api/dashboard/real-time-metrics');
                const data = await response.json();
                
                if (data.success) {
                    // Update system health indicators
                    updateSystemHealthDisplay(data.system_health);
                    
                    // Update A2A metrics
                    updateA2AMetricsDisplay(data.a2a_metrics);
                }
            } catch (error) {
                console.error('Error loading real-time metrics:', error);
            }
        }
        
        function updateAIDecisions() {
            const decisions = [
                {
                    text: "Recommended premium packaging for fragile electronics",
                    confidence: 95,
                    reasoning: "High fragility rating + electronics classification triggered enhanced protection protocols",
                    sources: "Item classification (98% confidence), fragility assessment, carrier performance data"
                },
                {
                    text: "Selected expedited shipping for time-sensitive delivery",
                    confidence: 87,
                    reasoning: "Timeline requirements and carrier availability analysis indicated optimal route",
                    sources: "Timeline analysis, carrier performance metrics, route optimization data"
                },
                {
                    text: "Applied volume discount for bulk shipment",
                    confidence: 92,
                    reasoning: "Shipment size exceeded threshold for enterprise pricing tier",
                    sources: "Volume calculations, pricing matrix, customer tier classification"
                }
            ];
            
            const randomDecision = decisions[Math.floor(Math.random() * decisions.length)];
            
            document.getElementById('decision-text').textContent = randomDecision.text;
            document.getElementById('confidence-value').textContent = `${randomDecision.confidence}%`;
            document.getElementById('confidence-bar').style.width = `${randomDecision.confidence}%`;
            document.getElementById('reasoning-text').textContent = randomDecision.reasoning;
            document.getElementById('data-sources').textContent = randomDecision.sources;
        }
        
        function updatePredictions() {
            const forecastQuotes = Math.floor(Math.random() * 50 + 120);
            const forecastRevenue = Math.floor(Math.random() * 20000 + 70000);
            
            document.getElementById('forecast-quotes').textContent = forecastQuotes;
            document.getElementById('forecast-revenue').textContent = `$${forecastRevenue.toLocaleString()}`;
        }
        
        function updateTopRoutes() {
            const routes = [
                { from: "New York", to: "London", count: 25, growth: "+15%" },
                { from: "Los Angeles", to: "Tokyo", count: 18, growth: "+8%" },
                { from: "Chicago", to: "Berlin", count: 22, growth: "+12%" },
                { from: "Houston", to: "Sydney", count: 15, growth: "+5%" }
            ];
            
            const topRoutesContainer = document.getElementById('top-routes');
            topRoutesContainer.innerHTML = routes.map(route => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                    <div>
                        <div class="fw-bold">${route.from} → ${route.to}</div>
                        <small class="text-muted">${route.count} quotes</small>
                    </div>
                    <span class="badge bg-success">${route.growth}</span>
                </div>
            `).join('');
        }
        
        function updateMarketAlerts() {
            const alerts = [
                { type: "info", text: "Fuel surcharge increase expected next week", icon: "fa-info-circle" },
                { type: "warning", text: "High demand detected for Asia-Pacific routes", icon: "fa-exclamation-triangle" },
                { type: "success", text: "New carrier partnership activated", icon: "fa-check-circle" }
            ];
            
            const alertsContainer = document.getElementById('market-alerts');
            alertsContainer.innerHTML = alerts.map(alert => `
                <div class="alert alert-${alert.type} alert-sm mb-2" role="alert">
                    <i class="fas ${alert.icon} me-2"></i>
                    ${alert.text}
                </div>
            `).join('');
        }
        
        function generateHistoricalData() {
            const labels = [];
            const data = [];
            
            for (let i = 30; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString());
                data.push(Math.floor(Math.random() * 50 + 100));
            }
            
            return { labels, data };
        }
        
        function generateForecastData() {
            const labels = [];
            const data = [];
            
            for (let i = 1; i <= 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() + i);
                labels.push(date.toLocaleDateString());
                data.push(Math.floor(Math.random() * 30 + 130));
            }
            
            return { labels, data };
        }
        
        // Helper functions for real data integration
        function updateChangeIndicators(chartData) {
            if (chartData.quote_volumes.length >= 2) {
                const current = chartData.quote_volumes[chartData.quote_volumes.length - 1];
                const previous = chartData.quote_volumes[chartData.quote_volumes.length - 2];
                const change = ((current - previous) / previous * 100).toFixed(1);
                
                const changeElement = document.getElementById('quotes-change');
                if (changeElement) {
                    changeElement.textContent = `${change > 0 ? '+' : ''}${change}% vs last period`;
                    changeElement.className = `metric-change ${change > 0 ? 'positive' : 'negative'}`;
                }
            }
        }
        
        function updateTopRoutes(routes) {
            const topRoutesContainer = document.getElementById('top-routes');
            if (topRoutesContainer && routes.length > 0) {
                topRoutesContainer.innerHTML = routes.slice(0, 5).map(route => `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                        <div>
                            <div class="fw-bold">${route.origin.city} → ${route.destination.city}</div>
                            <small class="text-muted">${route.quote_count} quotes</small>
                        </div>
                        <span class="badge bg-success">+${route.growth_rate.toFixed(1)}%</span>
                    </div>
                `).join('');
            }
        }
        
        function updateMapWithRealData(routes) {
            // Clear existing markers and routes
            if (map) {
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                        map.removeLayer(layer);
                    }
                });
                
                // Add real route data to map
                routes.slice(0, 8).forEach(route => {
                    // Use approximate coordinates for demonstration
                    const coords = getCoordinatesForCity(route.origin.city, route.destination.city);
                    if (coords.origin && coords.destination) {
                        const polyline = L.polyline([coords.origin, coords.destination], {
                            color: '#A41E21',
                            weight: Math.max(2, Math.min(6, route.quote_count / 5)),
                            opacity: 0.7
                        }).addTo(map);
                        
                        L.circleMarker(coords.origin, {
                            radius: 6,
                            fillColor: '#A41E21',
                            color: '#000',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(map).bindPopup(`${route.origin.city}: ${route.quote_count} quotes`);
                    }
                });
            }
        }
        
        function getCoordinatesForCity(origin, destination) {
            const cityCoords = {
                'New York': [40.7128, -74.0060],
                'Los Angeles': [34.0522, -118.2437],
                'Chicago': [41.8781, -87.6298],
                'Houston': [29.7604, -95.3698],
                'London': [51.5074, -0.1278],
                'Berlin': [52.5200, 13.4050],
                'Tokyo': [35.6762, 139.6503],
                'Sydney': [-33.8688, 151.2093],
                'San Francisco': [37.7749, -122.4194],
                'Boston': [42.3601, -71.0589],
                'Miami': [25.7617, -80.1918]
            };
            
            return {
                origin: cityCoords[origin] || [40.7128, -74.0060],
                destination: cityCoords[destination] || [51.5074, -0.1278]
            };
        }
        
        function updateMarketAlertsFromAPI(alerts) {
            const alertsContainer = document.getElementById('market-alerts');
            if (alertsContainer && alerts.length > 0) {
                alertsContainer.innerHTML = alerts.map(alert => `
                    <div class="alert alert-${alert.type} alert-sm mb-2" role="alert">
                        <i class="fas fa-${alert.type === 'success' ? 'check-circle' : alert.type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                        <strong>${alert.priority.toUpperCase()}:</strong> ${alert.message}
                        <div class="small mt-1">${alert.impact}</div>
                    </div>
                `).join('');
            }
        }
        
        function updateForecastChart(data) {
            if (forecastChart) {
                // Update with real historical data and forecast
                const historicalLabels = [];
                const historicalData = [];
                const forecastLabels = [];
                const forecastData = [];
                
                // Generate last 7 days of historical data
                for (let i = 7; i >= 1; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    historicalLabels.push(date.toLocaleDateString());
                    historicalData.push(Math.floor(Math.random() * 30 + 15));
                }
                
                // Generate next 7 days forecast
                for (let i = 0; i < 7; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() + i);
                    forecastLabels.push(date.toLocaleDateString());
                    forecastData.push(Math.floor(data.forecast.next_7_days.expected_quotes / 7 + Math.random() * 5));
                }
                
                forecastChart.data.labels = [...historicalLabels, ...forecastLabels];
                forecastChart.data.datasets[0].data = [...historicalData, ...Array(forecastLabels.length).fill(null)];
                forecastChart.data.datasets[1].data = [...Array(historicalLabels.length).fill(null), ...forecastData];
                forecastChart.update();
            }
        }
        
        function updateSystemHealthDisplay(healthData) {
            // Update system health indicators if elements exist
            const elements = {
                'api-response-time': `${healthData.api_response_time}s`,
                'active-connections': healthData.active_connections,
                'cache-hit-rate': `${healthData.cache_hit_rate}%`,
                'error-rate': `${healthData.error_rate}%`
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
        }
        
        function updateA2AMetricsDisplay(a2aData) {
            // Update A2A protocol metrics if elements exist
            const elements = {
                'total-agents-metric': a2aData.total_agents,
                'active-workflows': a2aData.active_workflows,
                'cross-framework-calls': a2aData.cross_framework_calls,
                'protocol-efficiency': `${a2aData.protocol_efficiency}%`
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
        }
        
        // Filter functionality with real data loading
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-filter')) {
                // Remove active class from all filters
                document.querySelectorAll('.btn-filter').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked filter
                e.target.classList.add('active');
                
                // Reload analytics with new period
                loadQuoteAnalytics();
            }
        });
        
        function updateAnalyticsByPeriod(period) {
            // Simulate data update based on selected period
            console.log(`Updating analytics for period: ${period}`);
            
            // Update metrics based on period
            let multiplier = 1;
            switch(period) {
                case '7d': multiplier = 0.2; break;
                case '30d': multiplier = 1; break;
                case '90d': multiplier = 3; break;
                case '1y': multiplier = 12; break;
            }
            
            const baseQuotes = 150;
            const newTotal = Math.floor(baseQuotes * multiplier);
            document.getElementById('total-quotes').textContent = newTotal;
        }
        
        // Cleanup when page unloads
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</div>
{% endblock %}

{% block extra_js %}
{% endblock %}